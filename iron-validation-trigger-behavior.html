<link rel="import" href="../polymer/polymer.html">

<script>

    // TODO: rename this behavior and its methods and move into new repo(InteractionStatebehavior), since it's only responsible for interaction state

    /**
     * 'Polymer.IronValidationTriggerBehavior` decides when form input will be validated.
     * The behavior needs to be applied to iron-input (or other elements implementing bindValue and `ironValidatablebehavior`).
     *
     * Validation of a form field will be triggered when the user:
     * <ol>
     *   <li>leaves a form field -> This will be applied when input is still 'untouched'</li>
     *   <li>on keyup (actually, on the input event) -> This will be applied when input already 'touched'</li>
     * </ol>
     *
     * By default, this behavior is disabled when applied. In order to enable, set the 'auto-validate' property ro true
     *
     * @demo demo/index.html
     * @element iron-validation-trigger-behavior
     * @polymerBehavior
     */
    Polymer.IronValidationTriggerBehavior = {

        properties: {
            /**
             * Determines what will be used as value changed event. Default is bind-value.
             * Define this property if other attribute should be used.
             */
            attrForValue: {
                type: String,
                value: 'bind-value'
            },

            /**
             * This boolean represents state about how a user has interacted with a form, meant to be used for UI updates about validation state of the input.
             * True when user has focused and left(blurred) the field.
             * Note this field will be reset when a user leaves a field when it's empty: the user will start with a clean slate the next time he will interact with the input
             */
            touched: {
                type: Boolean,
                readOnly: true,
                value: false,
                notify:true
            },

            /**
             * This boolean represents state about how a user has interacted with a form, meant to be used for UI updates about validation state of the input.
             * True when user has typed in something in the input field.
             */
            dirty: {
                type: Boolean,
                readOnly: true,
                value: false,
                notify:true
            }

        },

        get _valueChangedEvent() {
            return this.attrForValue + '-changed';
        },

        /**
         * Register event handlers and validate prefilled inputs
         */
        attached: function () {
            this.addEventListener('blur', this._valTrigOnBlur.bind(this));
            this.addEventListener(this._valueChangedEvent, this._valTrigOnValueChange.bind(this));

            if (this.value) {
                this._setTouched(true); // treat this as if it were touched, so that validation will be performed on keyup
            }
        },

        /**
         * Deregister event handlers
         */
        detached: function () {
            this.removeEventListener('blur', this._valTrigOnBlur);
            this.removeEventListener(this._valueChangedEvent, this._valTrigOnValueChange);
        },

        /**
         * Sets touched value and validates when already dirty.
         * Resets the touched state when user leaves a field without a value. On next interaction, user will start with a clean slate
         * @private
         */
        _valTrigOnBlur: function () {
            this._setTouched(!!this.value || this.invalid); // touched state of empty, valid fields is reset
        },

        /**
         * Sets dirty value and validates when already touched or invalid
         * @private
         */
        _valTrigOnValueChange: function () {
            this._setDirty(true);
        }


    };

</script>
